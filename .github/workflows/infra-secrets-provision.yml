name: "Bootstrap | Provision Secrets"
run-name: "${{ format('ðŸ” Provision Secrets | {0}-{1} | #{2}', inputs.product, inputs.env, github.run_number) }}"

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment"
        type: choice
        options: [dev, qa, uat, prod]
        default: dev
      product:
        description: "Product (hrz = Azure Gov, pub = Azure Commercial)"
        type: choice
        options: [hrz, pub]
        default: hrz
      kv_sequence:
        description: "2-digit Key Vault sequence (01, 02, ...). Dest KV uses this (default 01)."
        type: string
        default: "01"

permissions:
  id-token: write
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Select cloud/tenant + DEST subscription (per product Ã— env)
      # Also select HUB subscription (source KV subscription)
      #
      # NOTE: You must provide these GitHub secrets:
      #   HRZ:
      #     AZ_SUB_HRZ_DEV, AZ_SUB_HRZ_QA, AZ_SUB_HRZ_UAT, AZ_SUB_HRZ_PROD, AZ_SUB_HRZ_CORE
      #   PUB:
      #     AZ_SUB_PUB_DEV, AZ_SUB_PUB_QA, AZ_SUB_PUB_UAT, AZ_SUB_PUB_PROD, AZ_SUB_PUB_CORE
      # ------------------------------------------------------------
      - name: Select cloud/tenant/subscriptions
        id: subsel
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"
          PRODUCT="${{ inputs.product }}"

          if [ "$PRODUCT" = "hrz" ]; then
            CLOUD_ENV="AzureUSGovernment"
            ARM_ENV="usgovernment"
            TENANT="${{ secrets.AZ_TENANT_HRZ }}"
            CLIENT_ID="${{ secrets.AZURE_CLIENT_ID_HRZ }}"
            AUDIENCE="api://AzureADTokenExchangeUSGov"

            case "$ENV" in
              dev)  DEST_SUB="${{ secrets.AZ_SUB_HRZ_DEV }}" ;;
              qa)   DEST_SUB="${{ secrets.AZ_SUB_HRZ_QA }}" ;;
              uat)  DEST_SUB="${{ secrets.AZ_SUB_HRZ_UAT }}" ;;
              prod) DEST_SUB="${{ secrets.AZ_SUB_HRZ_PROD }}" ;;
              *) echo "Unknown env: $ENV"; exit 1;;
            esac

            HUB_SUB="${{ secrets.AZ_SUB_HRZ_CORE }}"
          else
            CLOUD_ENV="AzureCloud"
            ARM_ENV="public"
            TENANT="${{ secrets.AZ_TENANT_PUB }}"
            CLIENT_ID="${{ secrets.AZURE_CLIENT_ID_PUB }}"
            AUDIENCE="api://AzureADTokenExchange"

            case "$ENV" in
              dev)  DEST_SUB="${{ secrets.AZ_SUB_PUB_DEV }}" ;;
              qa)   DEST_SUB="${{ secrets.AZ_SUB_PUB_QA }}" ;;
              uat)  DEST_SUB="${{ secrets.AZ_SUB_PUB_UAT }}" ;;
              prod) DEST_SUB="${{ secrets.AZ_SUB_PUB_PROD }}" ;;
              *) echo "Unknown env: $ENV"; exit 1;;
            esac

            HUB_SUB="${{ secrets.AZ_SUB_PUB_CORE }}"
          fi

          echo "CLOUD_ENV=$CLOUD_ENV"   >> $GITHUB_OUTPUT
          echo "ARM_ENV=$ARM_ENV"       >> $GITHUB_OUTPUT
          echo "TENANT=$TENANT"         >> $GITHUB_OUTPUT
          echo "CLIENT_ID=$CLIENT_ID"   >> $GITHUB_OUTPUT
          echo "AUDIENCE=$AUDIENCE"     >> $GITHUB_OUTPUT
          echo "DEST_SUB=$DEST_SUB"     >> $GITHUB_OUTPUT
          echo "HUB_SUB=$HUB_SUB"       >> $GITHUB_OUTPUT

      - name: Azure Login (initial context = destination subscription)
        uses: azure/login@v2
        with:
          client-id:       ${{ steps.subsel.outputs.CLIENT_ID }}
          tenant-id:       ${{ steps.subsel.outputs.TENANT }}
          subscription-id: ${{ steps.subsel.outputs.DEST_SUB }}
          environment:     ${{ steps.subsel.outputs.CLOUD_ENV }}
          audience:        ${{ steps.subsel.outputs.AUDIENCE }}

      - name: Resolve source/destination KV names (+ find SOURCE RG)
        id: cfg
        shell: bash
        env:
          ENV: ${{ inputs.env }}
          PRODUCT: ${{ inputs.product }}
          KV_SEQ: ${{ inputs.kv_sequence }}
          ARM_ENV: ${{ steps.subsel.outputs.ARM_ENV }}
          HUB_SUB: ${{ steps.subsel.outputs.HUB_SUB }}
          DEST_SUB: ${{ steps.subsel.outputs.DEST_SUB }}
        run: |
          set -euo pipefail

          # kv sequence validation
          if ! [[ "${KV_SEQ}" =~ ^[0-9]{2}$ ]]; then
            echo "kv_sequence must be two digits (e.g., 01, 02)"; exit 1
          fi

          # Hardcoded regions by product (since we removed region_short)
          if [ "${PRODUCT}" = "hrz" ]; then
            REGION="usaz"
          else
            REGION="cus"
          fi

          # Destination naming per your convention
          DEST_RG="rg-${PRODUCT}-${ENV}-${REGION}-01"
          DEST_KV="kvt-${PRODUCT}-${ENV}-${REGION}-${KV_SEQ}"

          # Source KV naming per your requirement:
          #   env dev/qa => np core
          #   env uat/prod => pr core
          if [ "${ENV}" = "dev" ] || [ "${ENV}" = "qa" ]; then
            CORE_PLANE="np"
          else
            CORE_PLANE="pr"
          fi

          if [ "${PRODUCT}" = "hrz" ]; then
            SRC_KV="kvt-hrz-${CORE_PLANE}-usaz-core-01"
          else
            SRC_KV="kvt-pub-${CORE_PLANE}-cus-core-01"
          fi

          # Find source RG by querying the vault in the HUB subscription (needed to toggle PNA)
          az account set --subscription "${HUB_SUB}"
          SRC_RG="$(az keyvault show -n "${SRC_KV}" --query resourceGroup -o tsv)"
          if [ -z "${SRC_RG}" ]; then
            echo "Could not resolve source resource group for ${SRC_KV} in hub subscription ${HUB_SUB}"
            exit 1
          fi

          # endpoint suffix for storage conn strings (kept for compatibility/logging if you later re-add generators)
          if [ "${ARM_ENV}" = "usgovernment" ]; then
            STORAGE_SUFFIX="core.usgovcloudapi.net"
          else
            STORAGE_SUFFIX="core.windows.net"
          fi

          {
            echo "region=${REGION}"
            echo "dest_rg=${DEST_RG}"
            echo "dest_kv=${DEST_KV}"
            echo "src_kv=${SRC_KV}"
            echo "src_rg=${SRC_RG}"
            echo "storage_suffix=${STORAGE_SUFFIX}"
          } >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  env/product: ${ENV}/${PRODUCT}"
          echo "  region:      ${REGION}"
          echo "  SOURCE KV:   ${SRC_KV} (rg: ${SRC_RG}, sub: ${HUB_SUB})"
          echo "  DEST KV:     ${DEST_KV} (rg: ${DEST_RG}, sub: ${DEST_SUB})"
          echo "  suffix:      ${STORAGE_SUFFIX}"

      # ------------------------------------------------------------
      # OPEN BOTH KVs (PNA Enable + Allow) across subscriptions
      # ------------------------------------------------------------
      - name: Open SOURCE KV (PNA Enable + Allow)
        shell: bash
        env:
          HUB_SUB: ${{ steps.subsel.outputs.HUB_SUB }}
          SRC_RG:  ${{ steps.cfg.outputs.src_rg }}
          SRC_KV:  ${{ steps.cfg.outputs.src_kv }}
        run: |
          set -euo pipefail
          az account set --subscription "${HUB_SUB}"
          az keyvault update -g "${SRC_RG}" -n "${SRC_KV}" --public-network-access Enabled --only-show-errors
          az keyvault update -g "${SRC_RG}" -n "${SRC_KV}" --default-action Allow --only-show-errors
          sleep 10

      - name: Open DEST KV (PNA Enable + Allow)
        shell: bash
        env:
          DEST_SUB: ${{ steps.subsel.outputs.DEST_SUB }}
          DEST_RG:  ${{ steps.cfg.outputs.dest_rg }}
          DEST_KV:  ${{ steps.cfg.outputs.dest_kv }}
        run: |
          set -euo pipefail
          az account set --subscription "${DEST_SUB}"
          az keyvault update -g "${DEST_RG}" -n "${DEST_KV}" --public-network-access Enabled --only-show-errors
          az keyvault update -g "${DEST_RG}" -n "${DEST_KV}" --default-action Allow --only-show-errors
          sleep 10

      - name: Copy env-prefixed secrets from SOURCE KV -> DEST KV (create/update only if different)
        shell: bash
        env:
          ENV: ${{ inputs.env }}
          SRC_KV: ${{ steps.cfg.outputs.src_kv }}
          DEST_KV: ${{ steps.cfg.outputs.dest_kv }}
          HUB_SUB: ${{ steps.subsel.outputs.HUB_SUB }}
          DEST_SUB: ${{ steps.subsel.outputs.DEST_SUB }}
        run: |
          set -euo pipefail

          ENV_UP="$(echo "${ENV}" | tr '[:lower:]' '[:upper:]')"
          PREFIX="${ENV_UP}--"

          echo "Will copy secrets with prefix: ${PREFIX}"
          echo "SOURCE: ${SRC_KV} (sub ${HUB_SUB})"
          echo "DEST:   ${DEST_KV} (sub ${DEST_SUB})"

          total=0 created=0 updated=0 unchanged=0 errors=0

          set_kv_secret () {
            local name="$1" value="$2"
            echo "::add-mask::$value"
            args=(--vault-name "$DEST_KV" --name "$name" --value "$value" --only-show-errors)

            local tries=8 delay=4
            for ((i=1;i<=tries;i++)); do
              if az keyvault secret set "${args[@]}" >/dev/null 2>err.log; then
                rm -f err.log
                return 0
              fi
              if grep -qiE 'Forbidden|ForbiddenByFirewall' err.log; then
                echo "â€¦ retrying set ${name} in ${delay}s"
                sleep "$delay"
                delay=$(( delay<30 ? delay*2 : 30 ))
                continue
              fi
              echo "âœ— set ${name} failed:"
              cat err.log >&2
              rm -f err.log
              return 1
            done
            echo "âœ— set ${name} timed out"
            [ -f err.log ] && cat err.log >&2
            rm -f err.log || true
            return 1
          }

          az account set --subscription "${HUB_SUB}"
          mapfile -t src_names < <(
            az keyvault secret list --vault-name "${SRC_KV}" \
              --query "[?starts_with(name, '${PREFIX}')].name" -o tsv
          )

          echo "Found ${#src_names[@]} source secrets matching ${PREFIX}"

          for full in "${src_names[@]}"; do
            total=$((total+1))

            az account set --subscription "${HUB_SUB}"
            src_val="$(az keyvault secret show --vault-name "${SRC_KV}" --name "${full}" --query "value" -o tsv)"
            echo "::add-mask::$src_val"

            dest_name="${full#${PREFIX}}"

            az account set --subscription "${DEST_SUB}"
            if az keyvault secret show --vault-name "${DEST_KV}" --name "${dest_name}" --query "id" -o tsv >/dev/null 2>&1; then
              dest_val="$(az keyvault secret show --vault-name "${DEST_KV}" --name "${dest_name}" --query "value" -o tsv)"
              echo "::add-mask::$dest_val"

              if [ "${src_val}" = "${dest_val}" ]; then
                unchanged=$((unchanged+1))
                echo "SKIP    ${dest_name} (unchanged)"
              else
                if set_kv_secret "${dest_name}" "${src_val}"; then
                  updated=$((updated+1))
                  echo "UPDATE  ${dest_name}"
                else
                  errors=$((errors+1))
                  echo "ERROR   ${dest_name} (update failed)" >&2
                fi
              fi
            else
              if set_kv_secret "${dest_name}" "${src_val}"; then
                created=$((created+1))
                echo "CREATE  ${dest_name}"
              else
                errors=$((errors+1))
                echo "ERROR   ${dest_name} (create failed)" >&2
              fi
            fi

            sleep 0.1
          done

          echo ""
          echo "Summary:"
          echo "  Total evaluated : ${total}"
          echo "  Created         : ${created}"
          echo "  Updated         : ${updated}"
          echo "  Unchanged (skip): ${unchanged}"
          echo "  Errors          : ${errors}"

          if [ "${errors}" -gt 0 ]; then
            echo "One or more secrets failed to sync." >&2
            exit 1
          fi

      # ------------------------------------------------------------
      # CLOSE BOTH KVs (always)
      # ------------------------------------------------------------
      - name: Close SOURCE KV (PNA Disable + Deny)
        if: ${{ always() }}
        shell: bash
        env:
          HUB_SUB: ${{ steps.subsel.outputs.HUB_SUB }}
          SRC_RG:  ${{ steps.cfg.outputs.src_rg }}
          SRC_KV:  ${{ steps.cfg.outputs.src_kv }}
        run: |
          set -euo pipefail
          az account set --subscription "${HUB_SUB}"
          az keyvault update -g "${SRC_RG}" -n "${SRC_KV}" --default-action Deny --only-show-errors
          az keyvault update -g "${SRC_RG}" -n "${SRC_KV}" --public-network-access Disabled --only-show-errors
          az keyvault show -g "${SRC_RG}" -n "${SRC_KV}" \
            --query "{pna:properties.publicNetworkAccess, firewallDefaultAction:properties.networkAcls.defaultAction}" -o table || true

      - name: Close DEST KV (PNA Disable + Deny)
        if: ${{ always() }}
        shell: bash
        env:
          DEST_SUB: ${{ steps.subsel.outputs.DEST_SUB }}
          DEST_RG:  ${{ steps.cfg.outputs.dest_rg }}
          DEST_KV:  ${{ steps.cfg.outputs.dest_kv }}
        run: |
          set -euo pipefail
          az account set --subscription "${DEST_SUB}"
          az keyvault update -g "${DEST_RG}" -n "${DEST_KV}" --default-action Deny --only-show-errors
          az keyvault update -g "${DEST_RG}" -n "${DEST_KV}" --public-network-access Disabled --only-show-errors
          az keyvault show -g "${DEST_RG}" -n "${DEST_KV}" \
            --query "{pna:properties.publicNetworkAccess, firewallDefaultAction:properties.networkAcls.defaultAction}" -o table || true
