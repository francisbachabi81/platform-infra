name: Dispatch Stack Plan

on:
  workflow_call:
    inputs:
      stack:
        type: string
        required: true
      product:
        type: string
        required: true

      # env-based stacks: dev/qa/uat/prod
      env:
        type: string
        required: true

      # nonprod/prod plane stacks
      plane_std:
        type: string
        required: true

      # core-only plane: np/pr
      core_plane:
        type: string
        required: true

      pr_number:
        type: string
        required: false
      gate:
        type: string
        required: false
        default: pr

jobs:
  core:
    if: ${{ inputs.stack == 'core' }}
    uses: ./.github/workflows/core-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      plane: ${{ inputs.core_plane }}     # np/pr
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit

  shared-network:
    if: ${{ inputs.stack == 'shared-network' }}
    uses: ./.github/workflows/shared-network-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      plane: ${{ inputs.plane_std }}      # nonprod/prod
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit

  platform-app:
    if: ${{ inputs.stack == 'platform-app' }}
    uses: ./.github/workflows/platform-app-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      env: ${{ inputs.env }}              # dev/qa/uat/prod
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit

  observability:
    if: ${{ inputs.stack == 'observability' }}
    uses: ./.github/workflows/observability-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      env: ${{ inputs.env }}              # dev/qa/uat/prod
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit

  app-gateway-config:
    if: ${{ inputs.stack == 'app-gateway-config' }}
    uses: ./.github/workflows/app-gateway-config-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      plane: ${{ inputs.plane_std }}      # nonprod/prod
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit
    
  afd-config:
    if: ${{ inputs.stack == 'afd-config' }}
    uses: ./.github/workflows/afd-config-governed-plan-apply.yml
    with:
      mode: plan
      gate: ${{ inputs.gate }}
      product: ${{ inputs.product }}
      plane: ${{ inputs.plane_std }}    # assuming nonprod/prod
      pr_number: ${{ inputs.pr_number }}
    secrets: inherit

  unknown:
    if: >-
      ${{
        inputs.stack != 'core' &&
        inputs.stack != 'shared-network' &&
        inputs.stack != 'platform-app' &&
        inputs.stack != 'observability' &&
        inputs.stack != 'app-gateway-config' &&
        inputs.stack != 'afd-config'
      }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "::error::Unknown stack '${{ inputs.stack }}'"
          exit 1
