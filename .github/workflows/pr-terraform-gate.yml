name: PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write
  actions: read
  issues: write

concurrency:
  group: pr-tf-gate-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  DEFAULT_PRODUCT: pub

  # Env-based stacks (platform-app, observability, etc.)
  DEFAULT_ENV: dev

  # Plane-based stacks that use nonprod/prod (shared-network, app-gateway-config, afd-config, etc.)
  DEFAULT_PLANE_STD: nonprod

  # Core-only plane (np/pr)
  DEFAULT_CORE_PLANE: np

jobs:
  # SECURITY GATE (ENTIRE REPO)
  veracode:
    name: Security Scan (Veracode)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Veracode IaC/Secrets Scan
        uses: veracode/container_iac_secrets_scanning@v1.0.6
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          command: "scan"
          type: "directory"
          source: "." # scan entire repo
          format: "json"
          debug: false
          fail_build: true

      - name: Upload Veracode results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-results-${{ github.run_id }}
          path: results.json

      - name: Gate on IaC findings (Critical/High) + Secrets
        shell: bash
        run: |
          set -euo pipefail

          FILE="results.json"
          if [ ! -f "$FILE" ]; then
            echo "❌ $FILE not found"
            exit 1
          fi

          CRIT_FAIL=$(jq '[.configs // [] | .[] | select((.Status // "") == "FAIL") | select((.Severity // "") == "CRITICAL")] | length' "$FILE")
          HIGH_FAIL=$(jq '[.configs // [] | .[] | select((.Status // "") == "FAIL") | select((.Severity // "") == "HIGH")]     | length' "$FILE")
          SECRETS=$(jq '(.secrets // []) | length' "$FILE")

          echo "IaC FAIL counts => CRITICAL: $CRIT_FAIL, HIGH: $HIGH_FAIL"
          echo "Secrets found   => $SECRETS"

          if [ "$CRIT_FAIL" -gt 0 ] || [ "$HIGH_FAIL" -gt 0 ] || [ "$SECRETS" -gt 0 ]; then
            echo "❌ Failing build: Critical/High IaC FAIL findings and/or secrets detected."
            exit 1
          fi

          echo "✅ Veracode Gate passed."

  # DETECT CHANGES + BUILD MATRIX
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      changed_any: ${{ steps.matrix.outputs.changed_any }}
      docs_only: ${{ steps.filter.outputs.docs-only }}
      product: ${{ steps.inputs.outputs.product }}
      env: ${{ steps.inputs.outputs.env }}
      plane_std: ${{ steps.inputs.outputs.plane_std }}
      core_plane: ${{ steps.inputs.outputs.core_plane }}

    steps:
      - uses: actions/checkout@v4

      - name: Paths filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            # Per-stack changes
            core:
              - 'stacks/core/**'
            shared-network:
              - 'stacks/shared-network/**'
            platform-app:
              - 'stacks/platform-app/**'
            observability:
              - 'stacks/observability/**'
            app-gateway-config:
              - 'stacks/app-gateway-config/**'
            afd-config:
              - 'stacks/afd-config/**'

            # Shared changes that can affect multiple stacks -> run ALL stacks
            global:
              - 'modules/**'
              - 'scripts/**'
              - '.github/workflows/**'
              - '.github/actions/**'
              - 'stacks/**/modules/**'
              - '**/*.tf'
              - '**/*.tfvars'
              - '**/*.tftpl'
              - '**/*.sh'
              - '**/*.ps1'

            # Docs-only changes (PR gate runs, but no terraform plans by default)
            docs-only:
              - 'README*'
              - 'docs/**'

      - name: Parse PR labels -> product/env/plane_std/core_plane
        id: inputs
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);

            const findVal = (prefix) => {
              const hit = labels.find(n => n.toLowerCase().startsWith(prefix));
              return hit ? hit.substring(prefix.length).trim() : null;
            };

            const product = (findVal("product:") || process.env.DEFAULT_PRODUCT).toLowerCase();
            const envVal  = (findVal("env:") || process.env.DEFAULT_ENV).toLowerCase();

            let planeStd  = (findVal("plane:") || "").toLowerCase();          // nonprod/prod
            let corePlane = (findVal("core-plane:") || "").toLowerCase();     // np/pr

            // If someone used plane:np/pr, treat it as a core-plane override
            if (planeStd === "np" || planeStd === "pr") {
              corePlane = planeStd;
              planeStd = "";
            }

            // Validate env
            const validEnvs = new Set(["dev","qa","uat","prod"]);
            if (!validEnvs.has(envVal)) {
              core.setFailed(`Invalid env '${envVal}'. Use env:dev|qa|uat|prod.`);
              return;
            }

            // Derive plane_std from env if not explicitly set
            const derivedPlaneStd = (envVal === "dev" || envVal === "qa") ? "nonprod" : "prod";
            if (!planeStd) planeStd = (process.env.DEFAULT_PLANE_STD || derivedPlaneStd).toLowerCase();

            if (planeStd !== "nonprod" && planeStd !== "prod") {
              core.setFailed(`Invalid plane '${planeStd}'. Use plane:nonprod or plane:prod (or core-plane:np/pr for core).`);
              return;
            }

            // Default core_plane from plane_std if not explicitly set
            if (!corePlane) corePlane = (planeStd === "prod") ? "pr" : "np";

            if (corePlane !== "np" && corePlane !== "pr") {
              core.setFailed(`Invalid core-plane '${corePlane}'. Use core-plane:np or core-plane:pr.`);
              return;
            }

            core.info(`Labels: ${labels.join(", ")}`);
            core.info(`Resolved product=${product}, env=${envVal}, plane_std=${planeStd}, core_plane=${corePlane}`);

            core.setOutput("product", product);
            core.setOutput("env", envVal);
            core.setOutput("plane_std", planeStd);
            core.setOutput("core_plane", corePlane);

      - name: Build matrix
        id: matrix
        shell: bash
        run: |
          set -euo pipefail

          ALL_STACKS=(core shared-network platform-app observability app-gateway-config afd-config)
          stacks=()

          # If "global" changed, run ALL stacks
          if [[ "${{ steps.filter.outputs.global }}" == "true" ]]; then
            stacks=("${ALL_STACKS[@]}")
          else
            [[ "${{ steps.filter.outputs.core }}" == "true" ]] && stacks+=("core")
            [[ "${{ steps.filter.outputs.shared-network }}" == "true" ]] && stacks+=("shared-network")
            [[ "${{ steps.filter.outputs.platform-app }}" == "true" ]] && stacks+=("platform-app")
            [[ "${{ steps.filter.outputs.observability }}" == "true" ]] && stacks+=("observability")
            [[ "${{ steps.filter.outputs.app-gateway-config }}" == "true" ]] && stacks+=("app-gateway-config")
            [[ "${{ steps.filter.outputs.afd-config }}" == "true" ]] && stacks+=("afd-config")
          fi

          if (( ${#stacks[@]} == 0 )); then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            echo "changed_any=false" >> "$GITHUB_OUTPUT"
            echo "No Terraform-impacting changes detected."
            exit 0
          fi

          json='{"include":['
          first=1
          for s in "${stacks[@]}"; do
            [[ $first -eq 1 ]] || json+=','
            first=0
            json+='{"stack":"'"$s"'"}'
          done
          json+=']}'

          echo "matrix=$json" >> "$GITHUB_OUTPUT"
          echo "changed_any=true" >> "$GITHUB_OUTPUT"
          echo "Detected stacks: ${stacks[*]}"

      - name: Job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## PR Gate"
            echo ""
            echo "- Product: \`${{ steps.inputs.outputs.product }}\`"
            echo "- Env: \`${{ steps.inputs.outputs.env }}\`"
            echo "- Plane (std): \`${{ steps.inputs.outputs.plane_std }}\`"
            echo "- Core plane: \`${{ steps.inputs.outputs.core_plane }}\`"
            echo ""
            echo "### Change classification"
            echo "- global: \`${{ steps.filter.outputs.global }}\`"
            echo "- docs-only: \`${{ steps.filter.outputs.docs-only }}\`"
            echo ""
            echo "### Changed stacks"
            if [[ "${{ steps.matrix.outputs.changed_any }}" != "true" ]]; then
              echo "_None_"
            else
              echo '```json'
              echo '${{ steps.matrix.outputs.matrix }}'
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # STACK PLANS (MATRIX)
  plan:
    name: Stack Plans
    needs: [veracode, detect]
    if: ${{ needs.detect.outputs.changed_any == 'true' && !github.event.pull_request.draft }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.detect.outputs.matrix) }}
    uses: ./.github/workflows/_dispatch-stack-plan.yml
    with:
      stack: ${{ matrix.stack }}
      product: ${{ needs.detect.outputs.product }}
      env: ${{ needs.detect.outputs.env }}
      plane_std: ${{ needs.detect.outputs.plane_std }}
      core_plane: ${{ needs.detect.outputs.core_plane }}
      pr_number: ${{ github.event.pull_request.number }}
      gate: pr
    secrets: inherit

  # DOCS
  docs-only:
    name: Documentation only (no Terraform plans)
    needs: [veracode, detect]
    if: ${{ needs.detect.outputs.changed_any != 'true' && needs.detect.outputs.docs_only == 'true' && !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Docs-only change detected. No Terraform plans required."

  # FALLBACK
  no-changes:
    name: No Terraform plans required
    needs: [veracode, detect]
    if: ${{ needs.detect.outputs.changed_any != 'true' || github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "No plans required (no Terraform-impacting changes or PR is draft)."
